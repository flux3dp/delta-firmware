#!/usr/bin/env python

from __future__ import absolute_import

import argparse
import psutil
import sys

from fluxmonitor.misc.flux_argparse import add_daemon_arguments, \
    apply_daemon_arguments
from fluxmonitor.watcher.flux_upnp import UpnpWatcher
from fluxmonitor.launcher import main


parser = argparse.ArgumentParser(description='flux upnp deamon')
add_daemon_arguments("fluxupnpd", parser)
options = parser.parse_args()
apply_daemon_arguments(options)


if options.stop_daemon:
    try:
        pid_handler = open(options.pidfile, 'r', 0)
        pid = int(pid_handler.read(), 10)

        proc = psutil.Process(pid)
        proc.terminate()

        proc.wait(5.)
        sys.exit(0)
    except psutil.TimeoutExpired as e:
        print("Error: Timeout while stopping daemon")
    except Exception as e:
        print("Error: %s" % e)
        sys.exit(1)
else:
    return_code = main(options, module=UpnpWatcher)
    sys.exit(return_code)
