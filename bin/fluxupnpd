#!/usr/bin/env python

from __future__ import absolute_import

import argparse
import psutil
import sys

from fluxmonitor.launcher import create_argument_parser

parser = argparse.ArgumentParser(description='flux upnp deamon')
create_argument_parser("fluxupnpd", parser)

options = parser.parse_args()

if options.daemon and options.shell:
    sys.stderr.write('--daemon and --shell option can not use at same time.\n')
    sys.exit(1)

if options.stop_daemon:
    try:
        pid_handler = open(options.pidfile, 'r', 0)
        pid = int(pid_handler.read(), 10)

        proc = psutil.Process(pid)
        proc.terminate()

        proc.wait(5.)
        sys.exit(0)
    except psutil.TimeoutExpired as e:
        print("Error: Timeout while stopping daemon")
    except Exception as e:
        print("Error: %s" % e)
        sys.exit(1)
else:
    from fluxmonitor.launcher import main
    from fluxmonitor.watcher.flux_upnp import UpnpWatcher

    return_code = main(options, module=UpnpWatcher)
    sys.exit(return_code)
