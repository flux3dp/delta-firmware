#!/usr/bin/env python

from __future__ import absolute_import

import argparse
import psutil
import sys

from fluxmonitor.config import add_config_arguments, load_config_arguments
from fluxmonitor.launcher import main, add_daemon_arguments
from fluxmonitor.watcher.hal_uart import HalUartWatcher


parser = argparse.ArgumentParser(description='flux hal uart deamon')
add_config_arguments(parser)
add_daemon_arguments("fluxhal-uartd", parser)
parser.add_argument('--debug', dest='debug', action='store_const',
                    const=True, default=False, help='Enable debug')


options = parser.parse_args()
load_config_arguments(options)

if options.stop_daemon:
    try:
        pid_handler = open(options.pidfile, 'r', 0)
        pid = int(pid_handler.read(), 10)

        proc = psutil.Process(pid)
        proc.terminate()

        proc.wait(5.)
        sys.exit(0)
    except psutil.TimeoutExpired as e:
        print("Error: Timeout while stopping daemon")
    except Exception as e:
        print("Error: %s" % e)
        sys.exit(1)
else:
    return_code = main(options, module=HalUartWatcher)
    sys.exit(return_code)
